# FASE 4: Persistent Agent Memory - Sistema de Agentes Persistentes

## üéØ Objetivo

Implementar el sistema completo de agentes persistentes que incluye:
- **Memoria persistente** con compresi√≥n inteligente (128K tokens)
- **Sistema de graduaci√≥n** con criterios de 85% success rate
- **Especializaci√≥n por dominios** (Python/SQL/Debug/ML/API)
- **Colaboraci√≥n entre agentes** para resoluci√≥n de problemas complejos
- **Base de datos completa** con esquemas optimizados

## üìã Componentes Implementados

### 1. üóÑÔ∏è Database Manager (`backend/agents/database.py`)

**Esquema de Base de Datos Completo:**
- **Agentes**: Informaci√≥n b√°sica, estado, m√©tricas de graduaci√≥n
- **Memorias**: Contenido, tipo, importancia, acceso
- **Interacciones**: Queries, respuestas, calidad, tiempo de ejecuci√≥n
- **Graduaciones**: Registro de agentes graduados con m√©tricas
- **Colaboraciones**: Interacciones entre agentes

**Caracter√≠sticas:**
- **SQLite/PostgreSQL** compatible
- **√çndices optimizados** para consultas r√°pidas
- **Relaciones foreign key** para integridad
- **Metadata JSON** para flexibilidad
- **Estad√≠sticas autom√°ticas** de la base de datos

**Tablas principales:**
```sql
agents (id, domain, status, created_at, last_updated, total_interactions, success_rate, graduation_score, memory_tokens, max_memory_tokens, metadata)
agent_memories (id, agent_id, memory_type, content, tokens, importance_score, created_at, last_accessed, access_count, metadata)
agent_interactions (id, agent_id, query, response, success, quality_score, execution_time_ms, corrections_applied, context_used, created_at, metadata)
agent_graduations (id, agent_id, graduation_date, final_score, interactions_count, success_rate, memory_compression_ratio, playbook_contributions, metadata)
agent_collaborations (id, primary_agent_id, secondary_agent_id, collaboration_type, success, quality_score, created_at, metadata)
```

### 2. üß† Memory Manager (`backend/agents/memory_manager.py`)

**MemoryCompressor** - Compresi√≥n inteligente de memoria:
- **Compresi√≥n por tipo**: Conversaci√≥n, conocimiento, habilidades, experiencia, patrones
- **Estrategias espec√≠ficas** para cada tipo de memoria
- **L√≠mite de 128K tokens** con compresi√≥n autom√°tica
- **Preservaci√≥n de informaci√≥n cr√≠tica** durante compresi√≥n

**MemoryManager** - Gesti√≥n completa de memoria:
- **Cache inteligente** para acceso r√°pido
- **B√∫squeda por relevancia** basada en contenido
- **Tracking de acceso** y importancia
- **Compresi√≥n autom√°tica** cuando se excede el l√≠mite

**Tipos de memoria:**
- **CONVERSATION**: Di√°logos y interacciones
- **KNOWLEDGE**: Conocimiento factual y conceptos
- **SKILL**: Habilidades y t√©cnicas
- **EXPERIENCE**: Experiencias y lecciones aprendidas
- **PATTERN**: Patrones y soluciones reutilizables

**Estrategias de compresi√≥n:**
- **Conversaci√≥n**: Extracci√≥n de puntos clave
- **Conocimiento**: Filtrado de oraciones importantes
- **Habilidades**: Resumen de pasos y t√©cnicas
- **Experiencia**: Extracci√≥n de resultados y lecciones
- **Patrones**: Identificaci√≥n de patrones y ejemplos

### 3. üéì Graduation System (`backend/agents/graduation_system.py`)

**GraduationCriteria** - Criterios de graduaci√≥n:
- **85% success rate** m√≠nimo
- **100 interacciones** m√≠nimo
- **7.0 quality score** promedio
- **30% memory utilization** m√≠nimo
- **30 d√≠as m√°ximo** para graduarse
- **80% domain expertise** m√≠nimo

**GraduationEvaluator** - Evaluaci√≥n de agentes:
- **C√°lculo de m√©tricas** completas del agente
- **Evaluaci√≥n de criterios** autom√°tica
- **Score de graduaci√≥n** ponderado
- **Recomendaciones** para mejora
- **Estad√≠sticas de evaluaci√≥n** detalladas

**GraduationSystem** - Sistema completo:
- **Evaluaci√≥n masiva** de todos los agentes
- **Graduaci√≥n autom√°tica** cuando se cumplen criterios
- **Creaci√≥n de playbooks** basados en experiencias
- **Registro de graduaciones** con m√©tricas completas

**M√©tricas de graduaci√≥n:**
- Success rate, quality score, domain expertise
- Memory utilization, time efficiency
- Interaction count, collaboration success
- Playbook contributions, knowledge extraction

### 4. üåê Domain System (`backend/agents/domain_system.py`)

**DomainManager** - Gesti√≥n de dominios:
- **6 dominios especializados**: Python, SQL, JavaScript, Debug, ML, API
- **Prompts espec√≠ficos** por dominio y tipo
- **C√°lculo de expertise** basado en interacciones
- **Detecci√≥n autom√°tica** de dominio por contenido
- **Estad√≠sticas por dominio** detalladas

**CollaborationManager** - Colaboraci√≥n entre agentes:
- **5 tipos de colaboraci√≥n**: Knowledge sharing, problem solving, code review, mentoring, pair programming
- **B√∫squeda inteligente** de colaboradores
- **Gesti√≥n de solicitudes** de colaboraci√≥n
- **Tracking de resultados** y calidad
- **Estad√≠sticas de colaboraci√≥n** completas

**Dominios implementados:**
- **Python**: Sintaxis, OOP, librer√≠as, frameworks, testing
- **SQL**: Optimizaci√≥n, dise√±o, performance, administraci√≥n
- **JavaScript**: ES6+, Node.js, frameworks, async programming
- **Debug**: An√°lisis sistem√°tico, herramientas, profiling
- **ML**: Algoritmos, preprocessing, evaluaci√≥n, deployment
- **API**: RESTful design, documentaci√≥n, seguridad, microservicios

**Prompts por dominio:**
- **System prompt**: Especializaci√≥n y capacidades
- **Generation prompt**: Generaci√≥n de soluciones
- **Review prompt**: Revisi√≥n y an√°lisis de c√≥digo

### 5. ü§ñ Agent System (`backend/agents/agent_system.py`)

**PersistentAgent** - Agente individual:
- **Procesamiento de queries** con contexto enriquecido
- **Generaci√≥n de respuestas** usando prompts del dominio
- **Evaluaci√≥n de calidad** autom√°tica
- **Gesti√≥n de memoria** autom√°tica
- **Colaboraci√≥n opcional** con otros agentes
- **Tracking de estad√≠sticas** detalladas

**AgentSystem** - Sistema completo:
- **Creaci√≥n y gesti√≥n** de agentes
- **Carga desde base de datos** autom√°tica
- **Evaluaci√≥n de graduaciones** masiva
- **Estad√≠sticas consolidadas** del sistema
- **Integraci√≥n completa** de todos los componentes

**Caracter√≠sticas del agente:**
- **Memoria persistente** con compresi√≥n inteligente
- **Especializaci√≥n por dominio** con prompts espec√≠ficos
- **Colaboraci√≥n inteligente** con otros agentes
- **Evaluaci√≥n de calidad** autom√°tica
- **Tracking de m√©tricas** para graduaci√≥n
- **Gesti√≥n de contexto** enriquecido

## üöÄ Configuraci√≥n y Uso

### Configuraci√≥n de Base de Datos

```python
from backend.agents.database import DatabaseManager

# Crear manager de base de datos
db_manager = DatabaseManager("backend/data/agents.db")

# La base de datos se inicializa autom√°ticamente con el esquema completo
```

### Creaci√≥n de Agentes

```python
from backend.agents.agent_system import AgentSystem
from backend.agents.domain_system import DomainType

# Crear sistema de agentes
agent_system = AgentSystem()

# Crear agente especializado
python_agent = agent_system.create_agent(DomainType.PYTHON, "python_expert_001")
sql_agent = agent_system.create_agent(DomainType.SQL, "sql_expert_001")
ml_agent = agent_system.create_agent(DomainType.ML, "ml_expert_001")
```

### Procesamiento de Queries

```python
# Procesar query simple
result = python_agent.process_query(
    query="How to create a Python decorator?",
    context="Learning advanced Python concepts",
    user_intent="Understand decorators"
)

print(f"Response: {result['response']}")
print(f"Quality: {result['quality_score']}")
print(f"Success: {result['success']}")

# Procesar query con colaboraci√≥n
result_with_collab = python_agent.process_query(
    query="Complex Python optimization problem",
    context="Performance optimization",
    user_intent="Learn optimization techniques",
    require_collaboration=True
)
```

### Evaluaci√≥n de Graduaci√≥n

```python
# Evaluar todos los agentes
evaluation_results = agent_system.evaluate_graduations()

for result in evaluation_results:
    if result['eligible']:
        print(f"Agent {result['agent_id']} is ready for graduation!")
        print(f"Score: {result['graduation_score']:.2f}")
        
        # Graduar agente
        success = agent_system.graduate_agent(result['agent_id'])
        print(f"Graduation successful: {success}")
```

### Gesti√≥n de Memoria

```python
from backend.agents.memory_manager import MemoryManager, MemoryType

# Obtener memorias del agente
memories = python_agent.get_memories(MemoryType.KNOWLEDGE, limit=10)

for memory in memories:
    print(f"Memory: {memory.content[:100]}...")
    print(f"Importance: {memory.importance_score}")
    print(f"Access count: {memory.access_count}")

# Obtener memorias relevantes
relevant = python_agent.memory_manager.get_relevant_memories(
    python_agent.agent_id, "Python functions", limit=5
)
```

### Colaboraci√≥n entre Agentes

```python
from backend.agents.domain_system import CollaborationType

# Solicitar colaboraci√≥n
collaboration_request = agent_system.collaboration_manager.request_collaboration(
    requester_agent_id="python_expert_001",
    query="How to optimize database queries in Python?",
    context="Performance optimization",
    collaboration_type=CollaborationType.KNOWLEDGE_SHARING,
    target_domain=DomainType.SQL
)

if collaboration_request:
    print(f"Collaboration requested with {collaboration_request.target_agent_id}")
```

## üìä M√©tricas y Monitoreo

### M√©tricas de Agentes
- Total de interacciones
- Tasa de √©xito
- Score de graduaci√≥n
- Utilizaci√≥n de memoria
- Expertise por dominio
- Colaboraciones exitosas

### M√©tricas de Memoria
- Total de memorias
- Tokens utilizados
- Compresiones realizadas
- Tokens ahorrados
- Memorias pruned/merged
- Cache hit rate

### M√©tricas de Graduaci√≥n
- Agentes evaluados
- Agentes elegibles
- Agentes graduados
- Score promedio de graduaci√≥n
- Criterios m√°s/menos cumplidos
- Playbooks creados

### M√©tricas de Dominio
- Agentes por dominio
- Expertise promedio por dominio
- Colaboraciones por dominio
- Prompts m√°s utilizados
- Dominios m√°s activos

### M√©tricas de Colaboraci√≥n
- Solicitudes de colaboraci√≥n
- Colaboraciones completadas
- Tasa de √©xito de colaboraciones
- Score promedio de calidad
- Tipos de colaboraci√≥n m√°s exitosos

## üîß Configuraci√≥n Avanzada

### Criterios de Graduaci√≥n Personalizados

```python
from backend.agents.graduation_system import GraduationCriteria

# Personalizar criterios
custom_criteria = GraduationCriteria(
    min_success_rate=0.90,  # 90% en lugar de 85%
    min_interactions=150,   # 150 en lugar de 100
    min_quality_score=8.0,  # 8.0 en lugar de 7.0
    min_memory_utilization=0.4,  # 40% en lugar de 30%
    max_graduation_time_days=45,  # 45 d√≠as en lugar de 30
    min_domain_expertise=0.85  # 85% en lugar de 80%
)

# Usar criterios personalizados
graduation_system = GraduationSystem(db_manager, memory_manager, custom_criteria)
```

### Configuraci√≥n de Memoria

```python
from backend.agents.memory_manager import MemoryManager

# Configurar l√≠mite de memoria personalizado
memory_manager = MemoryManager(db_manager, max_tokens=256000)  # 256K tokens

# Configurar cache
memory_manager.clear_cache()  # Limpiar cache
memory_manager.clear_cache("agent_id")  # Limpiar cache espec√≠fico
```

### Prompts Personalizados por Dominio

```python
from backend.agents.domain_system import DomainManager, DomainType

# Agregar prompt personalizado
domain_manager = DomainManager(db_manager)
domain_manager.domain_prompts[DomainType.PYTHON]['custom_prompt'] = """
Custom prompt for Python agent:
- Focus on clean code
- Emphasize testing
- Include performance considerations
"""
```

## üß™ Testing

### Tests Unitarios
```bash
# Ejecutar tests de FASE 4
python backend/test_fase4.py
```

### Tests Espec√≠ficos
```python
# Test de base de datos
python -c "from backend.test_fase4 import test_database_manager; test_database_manager()"

# Test de memoria
python -c "from backend.test_fase4 import test_memory_manager; test_memory_manager()"

# Test de graduaci√≥n
python -c "from backend.test_fase4 import test_graduation_system; test_graduation_system()"
```

### Tests de Integraci√≥n
```python
# Test completo del sistema
agent_system = AgentSystem()
agent = agent_system.create_agent(DomainType.PYTHON)

# Simular muchas interacciones
for i in range(200):
    result = agent.process_query(f"Python question {i}")
    assert result['success']

# Evaluar graduaci√≥n
evaluation = agent_system.evaluate_graduations()
assert len(evaluation) > 0
```

## üìÅ Estructura de Archivos

```
backend/agents/
‚îú‚îÄ‚îÄ __init__.py              # Inicializaci√≥n del m√≥dulo
‚îú‚îÄ‚îÄ database.py              # Esquema y gesti√≥n de base de datos
‚îú‚îÄ‚îÄ memory_manager.py        # Gesti√≥n de memoria con compresi√≥n
‚îú‚îÄ‚îÄ graduation_system.py     # Sistema de graduaci√≥n de agentes
‚îú‚îÄ‚îÄ domain_system.py         # Dominios y colaboraci√≥n
‚îî‚îÄ‚îÄ agent_system.py          # Sistema completo de agentes

backend/data/
‚îî‚îÄ‚îÄ agents.db                # Base de datos SQLite de agentes

backend/test_fase4.py        # Tests completos de FASE 4
```

## üéØ Pr√≥ximos Pasos (FASE 5)

1. **Metadata System** - Captura completa de m√©tricas
2. **TimescaleDB** - Base de datos de series temporales
3. **Grafana Dashboards** - Visualizaci√≥n de m√©tricas
4. **Pipeline de Agregaci√≥n** - Procesamiento de datos
5. **Detecci√≥n de Anomal√≠as** - Monitoreo autom√°tico

## üìä Estado Actual

‚úÖ **Completado:**
- Database Manager con esquema completo
- Memory Manager con compresi√≥n inteligente
- Graduation System con criterios de 85%
- Domain System con 6 dominios especializados
- Collaboration Manager con 5 tipos de colaboraci√≥n
- Agent System completo con integraci√≥n
- Tests completos y documentaci√≥n

üîÑ **En Progreso:**
- Optimizaciones de performance
- Integraci√≥n con modelos reales
- Poblaci√≥n de datos de prueba

üìã **Pendiente:**
- Metadata System (FASE 5)
- TimescaleDB Setup (FASE 5)
- Grafana Dashboards (FASE 5)
- Fine-tuning Pipeline (FASE 6)

## ü§ù Contribuci√≥n

Para contribuir al sistema de agentes:

1. Fork del repositorio
2. Crear branch para feature
3. Implementar cambios con tests
4. Crear Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la licencia MIT. Ver `LICENSE` para m√°s detalles.

---

**FASE 4 completada exitosamente** üéâ

El sistema de agentes persistentes est√° listo para la integraci√≥n con el Metadata System en la FASE 5.
