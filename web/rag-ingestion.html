<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subida de Datos RAG - Capibara6</title>
    <link rel="stylesheet" href="chat-styles-neuromorphic-dark-v2.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --rag-primary: #8b5cf6;
            --rag-success: #10b981;
            --rag-warning: #f59e0b;
            --rag-error: #ef4444;
        }
        
        .rag-ingestion-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }
        
        .rag-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 3rem 2rem;
            text-align: center;
            margin: 1rem 0;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
        }
        
        .rag-upload-area:hover {
            border-color: var(--rag-primary);
            background: rgba(139, 92, 246, 0.05);
        }
        
        .rag-upload-area.dragover {
            border-color: var(--rag-primary);
            background: rgba(139, 92, 246, 0.1);
        }
        
        .rag-upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--rag-primary);
        }
        
        .rag-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .rag-progress-fill {
            height: 100%;
            background: var(--rag-primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .rag-job-status {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: var(--border-radius);
            background: var(--bg-secondary);
        }
        
        .rag-job-status.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--rag-success);
        }
        
        .rag-job-status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--rag-error);
        }
        
        .rag-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .rag-stat-card {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .rag-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--rag-primary);
        }
        
        .rag-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="rag-ingestion-container">
        <h1><i data-lucide="upload" style="width: 24px; height: 24px; vertical-align: middle;"></i> Subida de Datos RAG</h1>
        <p>Sube hasta 200MB de datos (texto o comprimido) para procesar en el sistema RAG</p>
        
        <div class="rag-upload-area" id="uploadArea">
            <div class="rag-upload-icon">
                <i data-lucide="file-text" style="width: 48px; height: 48px;"></i>
            </div>
            <h3>Suelta tus archivos aquí</h3>
            <p>o haz clic para seleccionar (textos, PDFs, documentos comprimidos)</p>
            <p class="text-muted">Tamaño máximo: 200MB</p>
            <input type="file" id="fileInput" multiple style="display: none;" accept=".txt,.pdf,.doc,.docx,.zip,.rar,.json,.xml">
            <button class="btn-primary" id="browseBtn">Seleccionar Archivos</button>
        </div>
        
        <div class="rag-progress-bar" id="progressBar" style="display: none;">
            <div class="rag-progress-fill" id="progressFill"></div>
        </div>
        <div id="progressText" style="text-align: center; margin: 0.5rem 0;"></div>
        
        <div id="jobStatus" class="rag-job-status" style="display: none;"></div>
        
        <div class="rag-stats" id="statsContainer" style="display: none;">
            <div class="rag-stat-card">
                <div class="rag-stat-value" id="totalDocs">0</div>
                <div class="rag-stat-label">Documentos</div>
            </div>
            <div class="rag-stat-card">
                <div class="rag-stat-value" id="totalBytes">0</div>
                <div class="rag-stat-label">Bytes Procesados</div>
            </div>
            <div class="rag-stat-card">
                <div class="rag-stat-value" id="activeJobs">0</div>
                <div class="rag-stat-label">Trabajos Activos</div>
            </div>
            <div class="rag-stat-card">
                <div class="rag-stat-value" id="successRate">0%</div>
                <div class="rag-stat-label">Tasa Éxito</div>
            </div>
        </div>
        
        <div id="fileList" style="margin-top: 2rem;"></div>
    </div>

    <script>
        // Inicializar íconos de Lucide
        lucide.createIcons();
        
        class RAGIngestionSystem {
            constructor() {
                this.uploadArea = document.getElementById('uploadArea');
                this.fileInput = document.getElementById('fileInput');
                this.browseBtn = document.getElementById('browseBtn');
                this.progressBar = document.getElementById('progressBar');
                this.progressFill = document.getElementById('progressFill');
                this.progressText = document.getElementById('progressText');
                this.jobStatus = document.getElementById('jobStatus');
                this.statsContainer = document.getElementById('statsContainer');
                this.fileList = document.getElementById('fileList');
                
                this.setupEventListeners();
                this.loadStats();
            }
            
            setupEventListeners() {
                // Eventos de arrastrar y soltar
                this.uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.add('dragover');
                });
                
                this.uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.remove('dragover');
                });
                
                this.uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    this.handleFiles(files);
                });
                
                // Evento de clic para abrir selector de archivos
                this.browseBtn.addEventListener('click', () => {
                    this.fileInput.click();
                });
                
                this.fileInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                });
            }
            
            handleFiles(files) {
                const fileArray = Array.from(files);
                
                fileArray.forEach(file => {
                    this.uploadFile(file);
                });
            }
            
            async uploadFile(file) {
                // Validar tamaño del archivo (200MB = 209715200 bytes)
                if (file.size > 209715200) {
                    this.showError(`Archivo ${file.name} excede el límite de 200MB`);
                    return;
                }

                // Mostrar barra de progreso
                this.progressBar.style.display = 'block';
                this.progressText.textContent = `Preparando ${file.name}...`;

                try {
                    // Determinar si es archivo de texto o binario
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    const isTextFile = ['txt', 'json', 'xml', 'csv', 'md'].includes(fileExtension);

                    if (isTextFile) {
                        // Procesar como texto plano
                        const fileContent = await this.readFileAsText(file);

                        // Enviar a RAG como texto
                        this.progressText.textContent = `Enviando ${file.name} (texto) al sistema RAG...`;

                        const response = await fetch('http://10.204.0.10:8000/api/v1/ingest/text', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                text: fileContent,
                                source_type: this.getFileType(file.name),
                                source_name: file.name,
                                metadata: {
                                    original_name: file.name,
                                    size: file.size,
                                    uploaded_at: new Date().toISOString()
                                }
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                        }

                        const result = await response.json();

                        // Actualizar UI con resultado
                        this.showSuccess(`Archivo ${file.name} enviado exitosamente. Job ID: ${result.job_id}`);
                        this.updateFileList(file, result.job_id, 'text');
                    } else {
                        // Procesar como archivo binario (para PDFs, docs, etc.)
                        const fileBuffer = await this.readFileAsArrayBuffer(file);

                        // Crear FormData para enviar archivo binario
                        const formData = new FormData();
                        formData.append('file', file, file.name);
                        formData.append('source_type', this.getFileType(file.name));
                        formData.append('source_name', file.name);
                        formData.append('metadata', JSON.stringify({
                            original_name: file.name,
                            size: file.size,
                            uploaded_at: new Date().toISOString()
                        }));

                        this.progressText.textContent = `Subiendo ${file.name} (binario) al sistema RAG...`;

                        const response = await fetch('http://10.204.0.10:8000/api/v1/ingest/file', {
                            method: 'POST',
                            body: formData // No incluimos Content-Type porque el navegador lo hará automáticamente con el boundary correcto
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                        }

                        const result = await response.json();

                        // Actualizar UI con resultado
                        this.showSuccess(`Archivo ${file.name} subido exitosamente. Job ID: ${result.job_id}`);
                        this.updateFileList(file, result.job_id, 'binary');
                    }

                    // Esperar y verificar estado del job
                    this.waitForJob(result.job_id);

                } catch (error) {
                    console.error('Error subiendo archivo:', error);
                    this.showError(`Error subiendo ${file.name}: ${error.message}`);
                } finally {
                    this.progressBar.style.display = 'none';
                    this.progressText.textContent = '';
                }
            }
            
            async readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }

            async readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }
            
            getFileType(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const typeMap = {
                    'txt': 'text',
                    'pdf': 'pdf',
                    'doc': 'document',
                    'docx': 'document',
                    'json': 'json',
                    'xml': 'xml',
                    'zip': 'archive',
                    'rar': 'archive'
                };
                return typeMap[ext] || 'text';
            }
            
            async waitForJob(jobId) {
                // Simular espera de job (en producción usarías el endpoint real)
                this.progressText.textContent = `Procesando job ${jobId}...`;
                
                // En producción, usarías: /api/v1/ingest/job/{job_id}
                setTimeout(async () => {
                    try {
                        // Simular verificación de estado
                        const jobStatus = await this.checkJobStatus(jobId);
                        if (jobStatus.status === 'completed') {
                            this.showSuccess(`Job ${jobId} completado exitosamente`);
                        } else if (jobStatus.status === 'failed') {
                            this.showError(`Job ${jobId} falló: ${jobStatus.error || 'Error desconocido'}`);
                        }
                    } catch (error) {
                        this.showError(`Error verificando job ${jobId}: ${error.message}`);
                    }
                }, 3000); // Simular tiempo de procesamiento
            }
            
            async checkJobStatus(jobId) {
                // En producción, usarías: GET /api/v1/ingest/job/{job_id}
                // Por ahora simulamos respuesta
                return {
                    status: 'completed',
                    job_id: jobId,
                    processed_at: new Date().toISOString(),
                    processed_bytes: 1000,
                    success: true
                };
            }
            
            async loadStats() {
                try {
                    const response = await fetch('http://10.204.0.10:8000/api/v1/ingest/stats');
                    if (response.ok) {
                        const stats = await response.json();
                        this.updateStats(stats);
                        this.statsContainer.style.display = 'grid';
                    }
                } catch (error) {
                    console.error('Error cargando stats:', error);
                }
            }
            
            updateStats(stats) {
                document.getElementById('totalDocs').textContent = stats.total_documents || 0;
                document.getElementById('totalBytes').textContent = this.formatBytes(stats.total_bytes || 0);
                document.getElementById('activeJobs').textContent = stats.active_jobs || 0;
                document.getElementById('successRate').textContent = `${stats.success_rate || 0}%`;
            }
            
            formatBytes(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            showSuccess(message) {
                this.jobStatus.className = 'rag-job-status success';
                this.jobStatus.textContent = message;
                this.jobStatus.style.display = 'block';
                
                setTimeout(() => {
                    this.jobStatus.style.display = 'none';
                }, 5000);
            }
            
            showError(message) {
                this.jobStatus.className = 'rag-job-status error';
                this.jobStatus.textContent = message;
                this.jobStatus.style.display = 'block';
            }
            
            updateFileList(file, jobId, fileType = 'unknown') {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-item';

                // Determinar ícono según tipo de archivo
                const getIcon = (filename, type) => {
                    const ext = filename.split('.').pop().toLowerCase();
                    if (['txt', 'json', 'xml', 'csv', 'md'].includes(ext)) {
                        return 'file-text';
                    } else if (['pdf'].includes(ext)) {
                        return 'file-pdf';
                    } else if (['zip', 'rar', '7z'].includes(ext)) {
                        return 'file-archive';
                    } else {
                        return 'file';
                    }
                };

                const iconType = getIcon(file.name, fileType);

                fileDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-secondary); border-radius: var(--border-radius); margin: 0.5rem 0;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="${iconType}" style="width: 16px; height: 16px; color: var(--rag-primary);"></i>
                            <div>
                                <strong>${file.name}</strong>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                    ${this.formatBytes(file.size)} · ${fileType.toUpperCase()}
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8rem; color: var(--rag-primary);">Job: ${jobId}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">Enviado: ${new Date().toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;

                this.fileList.insertBefore(fileDiv, this.fileList.firstChild);

                // Re-inicializar íconos de Lucide
                lucide.createIcons();
            }
        }
        
        // Inicializar sistema cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            new RAGIngestionSystem();
        });
    </script>
</body>
</html>